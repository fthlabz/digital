<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Dijital Sayfa</title>

  <!-- CryptoJS (admin şifre hash için) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

  <!-- Icons -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

  <style>
    /* =========================
      OBSIDIAN & GLASS — Business Elite Page
      (Single-file, no framework)
    ========================= */

    :root{
      --bg-void: #0c0c0c;
      --bg-navy: #1a1a2e;

      --txt-main: #f2f2f2;
      --txt-body: #d9d9d9;
      --txt-muted: rgba(242,242,242,.55);
      --txt-dim: rgba(242,242,242,.35);

      --gold: #efc07b;
      --gold-deep: #d4a35d;
      --teal: #33BECC;
      --sage: #557373;
      --rose: #a6445d;

      --glass: rgba(255,255,255,.03);
      --edge-top: rgba(255,255,255,.14);
      --edge-bot: rgba(0,0,0,.45);

      --r-lg: 20px;
      --r-md: 16px;
      --r-sm: 12px;

      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --shadow-soft: 0 10px 28px rgba(0,0,0,.45);
      --glow-gold: 0 0 22px rgba(239,192,123,.35);
      --glow-teal: 0 0 18px rgba(51,190,204,.25);
    }

    *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
    html,body{ height:100%; }

    body{
      margin:0;
      color: var(--txt-main);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(900px 520px at 50% 0%, rgba(239,192,123,.10), transparent 60%),
        linear-gradient(135deg, var(--bg-navy), var(--bg-void) 45%, var(--bg-void));
      overflow-x:hidden;
    }

    .bg-glow{
      position:fixed; inset:0;
      background:
        radial-gradient(700px 380px at 30% 10%, rgba(51,190,204,.10), transparent 60%),
        radial-gradient(900px 520px at 70% 0%, rgba(239,192,123,.10), transparent 60%);
      pointer-events:none;
      z-index:0;
    }

    .container{
      max-width: 520px;
      margin: 0 auto;
      min-height: 100vh;
      padding: 24px;
      display:flex;
      flex-direction:column;
      gap: 16px;
      position:relative;
      z-index:1;
    }

    /* Header */
    .header{
      text-align:center;
      padding: 14px 10px 8px;
    }
    .brand{
      font-family: "Space Grotesk", sans-serif;
      letter-spacing: .08em;
      text-transform: uppercase;
      font-weight: 700;
      font-size: 18px;
      color: var(--txt-main);
      opacity:.95;
    }
    .page-title{
      margin-top: 10px;
      font-family: "Space Grotesk", sans-serif;
      font-size: 28px;
      font-weight: 600;
      letter-spacing: .02em;
      color: var(--gold);
    }
    .slogan{
      margin-top: 6px;
      font-size: 12px;
      color: var(--txt-dim);
      font-style: italic;
    }

    /* Loading */
    #loading{
      margin-top: 52px;
      text-align:center;
      color: var(--txt-body);
      letter-spacing: .14em;
      font-size: 11px;
    }
    #loading i{ color: var(--gold); }

    /* Panels */
    .panel{ display:none; animation: fadeIn .45s ease-out; }
    @keyframes fadeIn{ from{opacity:0; transform: translateY(10px)} to{opacity:1; transform: translateY(0)} }

    /* Glass */
    .glass{
      background: var(--glass);
      backdrop-filter: blur(26px);
      -webkit-backdrop-filter: blur(26px);
      border-radius: var(--r-lg);
      border: 1px solid rgba(255,255,255,.06);
      box-shadow: var(--shadow-soft);
      position:relative;
      overflow:hidden;
    }
    .glass::before{
      content:"";
      position:absolute; inset:0;
      border-radius: inherit;
      pointer-events:none;
      box-shadow:
        inset 1px 1px 0 var(--edge-top),
        inset -1px -1px 0 var(--edge-bot);
    }

    /* Setup (Admin) */
    .hero-card{
      padding: 18px;
      border-radius: var(--r-lg);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border: 1px solid rgba(255,255,255,.07);
      box-shadow: var(--shadow-soft);
      position:relative;
    }
    .hero-title{
      font-family: "Space Grotesk", sans-serif;
      font-weight: 700;
      letter-spacing: .08em;
      text-transform: uppercase;
      color: var(--txt-main);
      font-size: 13px;
    }

    label{
      display:block;
      margin-top: 14px;
      margin-bottom: 8px;
      color: rgba(242,242,242,.45);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: .10em;
      font-weight: 600;
    }

    input, textarea{
      width:100%;
      background: transparent;
      border: none;
      border-bottom: 1px solid rgba(255,255,255,.18);
      color: var(--txt-main);
      padding: 14px 6px;
      outline:none;
      font-size: 14px;
      font-family: inherit;
    }
    textarea{ resize: vertical; min-height: 110px; }
    input:focus, textarea:focus{
      border-bottom-color: rgba(51,190,204,.9);
      box-shadow: 0 10px 22px rgba(51,190,204,.12);
    }

    .btn-gold{
      width:100%;
      border: none;
      padding: 16px 18px;
      border-radius: 999px;
      margin-top: 22px;
      cursor:pointer;
      background: linear-gradient(135deg, var(--gold), var(--gold-deep));
      color: var(--bg-void);
      font-weight: 800;
      letter-spacing: .08em;
      text-transform: uppercase;
      box-shadow: var(--glow-gold);
    }
    .btn-gold:disabled{ opacity:.7; cursor:not-allowed; }

    /* View (Business page) */
    .certificate{
      padding: 16px;
      border-radius: var(--r-lg);
      background: linear-gradient(180deg, rgba(239,192,123,.10), rgba(255,255,255,.03));
      border: 1px solid rgba(239,192,123,.28);
      box-shadow: var(--glow-gold);
      position:relative;
      overflow:hidden;
    }
    .cert-top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
    }
    .cert-badge{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      font-size: 11px;
      letter-spacing: .12em;
      text-transform: uppercase;
      color: rgba(242,242,242,.8);
      font-weight: 700;
    }
    .cert-badge i{ color: var(--gold); }
    .cert-meta{
      font-size: 12px;
      color: rgba(242,242,242,.55);
      white-space: nowrap;
    }
    .cert-line{
      margin-top: 10px;
      height: 1px;
      background: linear-gradient(90deg, rgba(239,192,123,.0), rgba(239,192,123,.45), rgba(239,192,123,.0));
    }

    .dock{
      margin-top: 6px;
    }
    .dock-inner{
      display:flex;
      justify-content:space-between;
      gap: 10px;
      padding: 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      backdrop-filter: blur(28px);
      -webkit-backdrop-filter: blur(28px);
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: var(--shadow-soft);
    }
    .dock-btn{
      flex:1;
      display:flex;
      align-items:center;
      justify-content:center;
      height: 52px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      color: var(--txt-main);
      cursor:pointer;
      position:relative;
    }
    .dock-btn i{ font-size: 18px; opacity:.95; }
    .dock-btn:active{ transform: scale(.99); }
    .dock-btn.scan{
      border-color: rgba(239,192,123,.35);
      background: rgba(239,192,123,.10);
      box-shadow: var(--glow-gold);
    }
    .dock-btn.scan i{ color: var(--gold); }

    .dock-labels{
      display:flex;
      justify-content:space-between;
      gap: 10px;
      padding: 8px 12px 0;
      color: var(--txt-dim);
      font-size: 10px;
      letter-spacing: .12em;
      text-transform: uppercase;
    }
    .dock-labels span{ flex:1; text-align:center; }

    .section-label{
      margin-top: 10px;
      font-size: 11px;
      letter-spacing: .14em;
      text-transform: uppercase;
      color: var(--txt-dim);
    }

    /* Flash campaign area */
    .flash{
      padding: 16px;
      border-radius: var(--r-lg);
    }
    .flash-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 12px;
    }
    .flash-title{
      font-family: "Space Grotesk", sans-serif;
      font-weight: 700;
      letter-spacing: .08em;
      text-transform: uppercase;
      font-size: 12px;
      color: rgba(242,242,242,.85);
      display:flex;
      align-items:center;
      gap: 10px;
    }
    .flash-title i{ color: var(--gold); }
    .flash-chip{
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(51,190,204,.35);
      background: rgba(51,190,204,.10);
      color: rgba(242,242,242,.85);
      font-size: 11px;
      letter-spacing: .06em;
      white-space: nowrap;
    }

    .flash-body{
      display:flex;
      flex-direction:column;
      gap: 12px;
    }

    .flash-media{
      width:100%;
      aspect-ratio: 16/10;
      border-radius: var(--r-md);
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.25);
      position:relative;
      box-shadow: var(--shadow-soft);
    }
    .flash-media img{
      width:100%;
      height:100%;
      object-fit: cover;
      display:block;
    }
    .flash-media .placeholder{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      flex-direction:column;
      gap: 10px;
      color: rgba(242,242,242,.55);
      font-size: 12px;
      letter-spacing: .08em;
      text-transform: uppercase;
    }
    .flash-media .placeholder i{ color: var(--gold); font-size: 22px; }

    .price-row{
      display:flex;
      gap: 12px;
    }
    .price-box{
      flex:1;
      padding: 12px;
      border-radius: var(--r-md);
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
    }
    .price-label{
      font-size: 10px;
      letter-spacing: .12em;
      text-transform: uppercase;
      color: rgba(242,242,242,.45);
      margin-bottom: 8px;
      font-weight: 700;
    }
    .price-val{
      font-family: "Space Grotesk", sans-serif;
      font-size: 18px;
      font-weight: 700;
      letter-spacing: .01em;
      color: var(--txt-main);
    }
    .price-val.old{
      text-decoration: line-through;
      color: rgba(242,242,242,.45);
      font-weight: 600;
    }
    .cta{
      display:flex;
      gap: 12px;
      align-items:center;
    }
    .cta input{
      border-bottom-color: rgba(255,255,255,.18);
      padding: 12px 6px;
      font-size: 13px;
    }
    .cta .btn-gold{
      width: 170px;
      margin-top: 0;
      padding: 14px 16px;
      font-size: 12px;
    }

    .footer{
      text-align:center;
      margin: 8px 0 20px;
      font-size: 10px;
      letter-spacing: .18em;
      color: rgba(242,242,242,.18);
    }

    .admin-edit{
      position: fixed;
      bottom: 22px;
      right: 18px;
      width: 44px; height: 44px;
      border-radius: 999px;
      display:flex; align-items:center; justify-content:center;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      backdrop-filter: blur(22px);
      -webkit-backdrop-filter: blur(22px);
      box-shadow: var(--shadow-soft);
      z-index: 10;
      color: rgba(242,242,242,.7);
      cursor:pointer;
    }
    .admin-edit i{ font-size: 14px; }
    .admin-edit:active{ transform: scale(.98); }

    /* Gallery overlay */
    #gallery-overlay{
      position:fixed; inset:0;
      background:#000;
      z-index:9999;
      display:none;
      flex-direction:column;
    }
    .gallery-header{
      height: 64px;
      padding: 0 18px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      background: rgba(12,12,12,.72);
      backdrop-filter: blur(26px);
      -webkit-backdrop-filter: blur(26px);
      border-bottom: 1px solid rgba(255,255,255,.08);
      flex-shrink:0;
    }
    .close-gallery{
      display:flex; align-items:center; gap: 8px;
      color: rgba(242,242,242,.85);
      font-size: 12px;
      letter-spacing: .10em;
      text-transform: uppercase;
      cursor:pointer;
    }
    #galTitle{
      font-family: "Space Grotesk", sans-serif;
      letter-spacing: .08em;
      text-transform: uppercase;
      color: var(--gold);
      font-weight: 800;
      font-size: 12px;
    }

    .slider-container{
      flex:1;
      display:flex;
      overflow-x:auto;
      overflow-y:hidden;
      scroll-snap-type:x mandatory;
      -webkit-overflow-scrolling:touch;
      align-items:center;
    }
    .slider-container::-webkit-scrollbar{ display:none; }
    .slide{
      flex:0 0 100%;
      height:100%;
      scroll-snap-align:center;
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
    }
    .slide img{
      max-width:100%;
      max-height:100%;
      object-fit:contain;
      pointer-events:none;
    }
    .slide iframe{
      width:100%;
      height:100%;
      border:none;
      pointer-events:auto;
    }
    .video-wrapper{
      width:100%;
      height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .spinner{
      color: var(--gold);
      font-size: 22px;
      position:absolute;
      top:50%; left:50%;
      transform:translate(-50%,-50%);
      text-align:center;
    }
    .error-msg{
      color: rgba(255,220,220,.9);
      font-size: 12px;
      text-align:center;
      margin-top: 100px;
      padding: 18px;
      background: rgba(166,68,93,.12);
      border-radius: 14px;
      width: 84%;
      margin-left:auto;
      margin-right:auto;
      border: 1px solid rgba(166,68,93,.35);
    }

    /* Text modal */
    #textModal{
      position:fixed; inset:0;
      background:#000;
      z-index:9999;
      display:none;
      flex-direction:column;
    }
    .text-modal-header{
      height: 64px;
      padding: 0 18px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      background: rgba(12,12,12,.72);
      backdrop-filter: blur(26px);
      -webkit-backdrop-filter: blur(26px);
      border-bottom: 1px solid rgba(255,255,255,.08);
      flex-shrink:0;
    }
    .text-body{
      flex:1;
      overflow-y:auto;
      padding: 24px;
      color: var(--txt-main) !important;
      font-family: Inter, sans-serif;
      font-size: 16px;
      line-height: 1.65;
      -webkit-overflow-scrolling: touch;
      white-space: pre-wrap;
    }

    /* Mobile tweaks */
    @media (max-width: 380px){
      .page-title{ font-size: 24px; }
      .dock-btn{ height: 48px; }
      .cta .btn-gold{ width: 150px; }
    }
  </style>
</head>

<body>
  <div class="bg-glow"></div>

  <div class="container">
    <!-- Header (Business) -->
    <div class="header">
      <div class="brand" id="brandName">ŞİRKET ADI</div>
      <div class="page-title" id="pageTitleTop">...</div>
      <div class="slogan" id="brandSlogan">"Slogan buraya"</div>
    </div>

    <div id="loading">
      <i class="fas fa-circle-notch fa-spin fa-2x"></i><br><br>
      Veriler Çekiliyor...
    </div>

    <!-- SETUP / ADMIN PANEL (first time OR admin edit) -->
    <div id="setup-panel" class="panel">
      <div class="hero-card">
        <div class="hero-title">Yönetici Kurulumu</div>
        <p style="font-size:12px; color: rgba(242,242,242,.55); margin:10px 0 0;">
          Bu sayfa izleyiciye şifresiz açılır. Düzenlemek için yönetici şifresi gerekir.
        </p>
      </div>

      <label>1) SAYFA BAŞLIĞI</label>
      <input type="text" id="inTitle" placeholder="Örn: Moda Şube / Kampanya Sayfası">

      <label>2) MİSYON / AÇIKLAMA METNİ</label>
      <textarea id="inNot" rows="4" placeholder="Örn: Bizim misyonumuz..."></textarea>

      <label>3) İLETİŞİM / TANITIM SESİ (Tek Drive Dosyası)</label>
      <input type="text" id="inSes" placeholder="Drive dosya linki">

      <label style="color: var(--gold); margin-top: 18px; border-top:1px dashed rgba(255,255,255,.18); padding-top:12px;">
        4) MEDYA KLASÖRLERİ
      </label>
      <input type="text" id="inVideoLink" placeholder="VİDEOLU REKLAMLAR (Klasör Linki)">
      <input type="text" id="inPhotoLink" placeholder="KAMPANYA & ÜRÜN GÖRSELLERİ (Klasör Linki)">

      <label style="color: var(--gold); margin-top: 18px;">YÖNETİCİ ŞİFRESİ</label>
      <input type="password" id="inPass" placeholder="Yönetici şifresi">
      <input type="password" id="inPassConfirm" placeholder="Şifre tekrar">

      <button class="btn-gold" onclick="saveData()">KAYDET</button>
    </div>

    <!-- VIEW / BUSINESS PAGE -->
    <div id="view-panel" class="panel">
      <!-- Certificate / Identity -->
      <div class="certificate">
        <div class="cert-top">
          <div class="cert-badge">
            <i class="fas fa-certificate"></i>
            RESMİ DİJİTAL SAYFA
          </div>
          <div class="cert-meta">
            ID: <span id="certId">...</span>
          </div>
        </div>
        <div class="cert-line"></div>
        <div style="margin-top:10px; font-size:12px; color: rgba(242,242,242,.55);">
          Kampanya, ürün görselleri ve reklam içerikleri bu sayfada yayınlanır.
        </div>
      </div>

      <!-- Floating Dock (keep existing functions, just business labels) -->
      <div class="dock">
        <div class="dock-inner">
          <div class="dock-btn" onclick="openTextModal()" title="Misyonumuz">
            <i class="fas fa-scroll"></i>
          </div>

          <div class="dock-btn scan" onclick="openGallery('photo')" id="storyPhoto" title="Kampanyalar">
            <i class="fas fa-tags"></i>
          </div>

          <div class="dock-btn" onclick="openGallery('video')" id="storyVideo" title="Videolu Reklamlar">
            <i class="fas fa-bullhorn"></i>
          </div>

          <div class="dock-btn" onclick="openLink('ses')" id="storySes" title="İletişim">
            <i class="fas fa-phone"></i>
          </div>
        </div>

        <div class="dock-labels">
          <span>Misyon</span>
          <span>Kampanya</span>
          <span>Reklam</span>
          <span>İletişim</span>
        </div>
      </div>

      <!-- Flash Campaign (replaces content list) -->
      <div class="section-label">Flash Kampanya</div>

      <div class="flash glass">
        <div class="flash-head">
          <div class="flash-title">
            <i class="fas fa-bolt"></i>
            ANLIK FIRSAT
          </div>
          <div class="flash-chip" id="flashState">Yayında</div>
        </div>

        <div class="flash-body">
          <div class="flash-media" id="flashMedia">
            <div class="placeholder" id="flashPlaceholder">
              <i class="fas fa-camera"></i>
              Fotoğraf yükle
              <div style="font-size:11px; color: rgba(242,242,242,.35); text-transform:none; letter-spacing:0;">
                (İzleyiciye anlık gösterim)
              </div>
            </div>
            <img id="flashImg" alt="" style="display:none;">
          </div>

          <!-- Hidden file input -->
          <input type="file" id="flashFile" accept="image/*" style="display:none;">

          <div class="price-row">
            <div class="price-box">
              <div class="price-label">Eski Fiyat</div>
              <div class="price-val old" id="oldPriceText">—</div>
              <input id="oldPrice" placeholder="Örn: 1.499₺" inputmode="text">
            </div>
            <div class="price-box">
              <div class="price-label">Yeni Fiyat</div>
              <div class="price-val" id="newPriceText">—</div>
              <input id="newPrice" placeholder="Örn: 999₺" inputmode="text">
            </div>
          </div>

          <div class="cta">
            <input id="ctaText" placeholder="CTA: Örn. WhatsApp’tan Sipariş" value="WhatsApp’tan Sipariş">
            <button class="btn-gold" onclick="runCTA()">Hemen</button>
          </div>

          <div style="font-size:12px; color: rgba(242,242,242,.45); line-height:1.5;">
            Not: Flash kampanya alanı bu sürümde anlıktır (sayfa yenilenince sıfırlanır).
            İstersen bunu Sheet’e kalıcı alan olarak da ekleriz (yapıyı büyütmeden).
          </div>
        </div>
      </div>

      <div class="admin-edit" onclick="enableEdit()"><i class="fas fa-pen"></i></div>
      <div class="footer">POWERED BY FTHLABZ</div>
    </div>
  </div>

  <!-- Gallery Overlay -->
  <div id="gallery-overlay">
    <div class="gallery-header">
      <div class="close-gallery" onclick="closeGallery()"><i class="fas fa-chevron-left"></i> Geri</div>
      <span id="galTitle">Albüm</span>
    </div>
    <div class="slider-container" id="slider-track"></div>
  </div>

  <!-- Text Modal (Misyon) -->
  <div id="textModal">
    <div class="text-modal-header">
      <div class="close-gallery" onclick="document.getElementById('textModal').style.display='none'">
        <i class="fas fa-chevron-left"></i> Kapat
      </div>
      <span style="color: var(--gold); font-weight:800; font-size:12px; letter-spacing:.10em; text-transform:uppercase;">
        Misyonumuz
      </span>
    </div>
    <div class="text-body" id="textContent"></div>
  </div>

  <script>
    // ✅ API URL (same)
    const API_URL = "https://script.google.com/macros/s/AKfycbyvtvYWLmkq8AqmCEhf_FP5fYLaliFpz_p-Jx4_miEM1vgCvHIM8qDS06A5kKP9F6W0ZA/exec";

    // ✅ Business header (static for now)
    // İstersen bunları da Sheet'ten yönetiriz, ama "yapıyı bozmadan" sabit tuttum:
    const BRAND_NAME = "FthLabz";
    const BRAND_SLOGAN = '"İşinizi büyüten premium dijital vitrin."';

    document.getElementById('brandName').innerText = BRAND_NAME;
    document.getElementById('brandSlogan').innerText = BRAND_SLOGAN;

    const urlParams = new URLSearchParams(window.location.search);
    const currentID = urlParams.get('id');

    // ✅ New model: viewer NO password
    // We'll treat stored data as plaintext.
    // Admin password hash stored in folder third segment: vLink|||pLink|||adminHash
    let pageData = {
      title: "",
      not: "",
      ses: "",
      vLink: "",
      pLink: "",
      adminHash: ""
    };

    window.onload = function() {
      if (!currentID) {
        document.getElementById('loading').innerHTML = "ID Yok";
        return;
      }

      document.getElementById('certId').innerText = currentID;

      fetch(API_URL + "?action=read&id=" + currentID)
        .then(res => res.json())
        .then(data => {
          document.getElementById('loading').style.display = 'none';

          if (data.status === "empty") {
            // first time setup
            document.getElementById('pageTitleTop').innerText = "Yeni Sayfa";
            document.getElementById('setup-panel').style.display = 'block';
            return;
          }

          // IMPORTANT:
          // Old records might have AES-encrypted strings in title/not/folder/ses.
          // New records are stored plaintext.
          // We'll attempt to detect encrypted data (starts with U2FsdGVkX1 = CryptoJS AES salt).
          const looksEncrypted = (v) => typeof v === 'string' && v.startsWith("U2FsdGVkX1");

          if (looksEncrypted(data.title) || looksEncrypted(data.not) || looksEncrypted(data.folder) || looksEncrypted(data.ses)) {
            // Legacy encrypted record — cannot be viewed without password, but viewer password is removed by requirement.
            // We show a graceful screen telling admin to re-save once.
            document.getElementById('pageTitleTop').innerText = "Güncelleme Gerekli";
            document.getElementById('view-panel').style.display = 'block';
            document.getElementById('textContent').innerText =
              "Bu sayfa eski sürümde şifreli kaydedilmiş.\n\nİzleyici şifresi kaldırıldığı için görüntüleme için içerik yeniden kaydedilmelidir.\n\nYönetici: Sağ alttaki kalem ikonuna bas → şifre ile düzenle → Kaydet.";
            // Hide media buttons to avoid confusion
            document.getElementById('storySes').style.display='none';
            document.getElementById('storyVideo').style.display='none';
            document.getElementById('storyPhoto').style.display='none';
            return;
          }

          // New plaintext record
          pageData.title = data.title || "";
          pageData.not = data.not || "";
          pageData.ses = data.ses || "";

          const folderStr = data.folder || "";
          const parts = folderStr.split("|||");
          pageData.vLink = parts[0] || "";
          pageData.pLink = parts[1] || "";
          pageData.adminHash = parts[2] || "";

          // Render
          document.getElementById('pageTitleTop').innerText = pageData.title || "Sayfa";
          document.getElementById('textContent').innerText = pageData.not || "";

          // Hide buttons if missing
          if (!pageData.ses) document.getElementById('storySes').style.display='none';
          if (!pageData.vLink) document.getElementById('storyVideo').style.display='none';
          if (!pageData.pLink) document.getElementById('storyPhoto').style.display='none';

          document.getElementById('view-panel').style.display = 'block';
        })
        .catch(err => alert("Bağlantı Hatası: URL'yi kontrol et."));
    };

    // === Viewer actions (same behavior) ===

    function openLink(type) {
      if (type === 'ses' && pageData.ses) {
        const overlay = document.getElementById('gallery-overlay');
        const slider = document.getElementById('slider-track');
        const titleEl = document.getElementById('galTitle');
        titleEl.innerText = "İletişim / Ses";
        slider.innerHTML = "";
        overlay.style.display = 'flex';

        let fileId = "";
        const rawLink = pageData.ses;
        const match = rawLink.match(/[-\w]{25,}/);
        if (match) fileId = match[0];

        if (fileId) {
          const playerUrl = `https://drive.google.com/file/d/${fileId}/preview`;
          slider.innerHTML = `<div class="slide"><div class="video-wrapper" style="height:50%;"><iframe src="${playerUrl}" allow="autoplay"></iframe></div></div>`;
        } else {
          slider.innerHTML = '<div class="error-msg">Link Hatalı</div>';
        }
      }
    }

    function openGallery(type) {
      let link = "";
      let title = "";
      if (type === 'video') { link = pageData.vLink; title = "Videolu Reklamlar"; }
      if (type === 'photo') { link = pageData.pLink; title = "Kampanyalar & Ürünler"; }

      if (!link) return;

      const overlay = document.getElementById('gallery-overlay');
      const slider = document.getElementById('slider-track');
      document.getElementById('galTitle').innerText = title;
      slider.innerHTML = '<div class="spinner"><i class="fas fa-circle-notch fa-spin"></i><br><span style="font-size:10px; letter-spacing:.12em; text-transform:uppercase;">Yükleniyor...</span></div>';
      overlay.style.display = 'flex';

      fetch(API_URL + "?action=getFiles&url=" + encodeURIComponent(link))
        .then(res => res.json())
        .then(data => {
          slider.innerHTML = "";
          if (data.status === "error") {
            slider.innerHTML = `<div class="error-msg">⚠️ BAĞLANTI HATASI<br>${data.msg}</div>`;
            return;
          }
          if (!data.files || data.files.length === 0) {
            slider.innerHTML = '<div class="error-msg">Bu klasör boş görünüyor.</div>';
            return;
          }

          data.files.forEach(file => {
            const slide = document.createElement('div');
            slide.className = 'slide';

            if (file.type === 'image') {
              const proxyUrl = "https://lh3.googleusercontent.com/d/" + file.id + "=s2000";
              slide.innerHTML = `<img src="${proxyUrl}" loading="lazy">`;
            } else if (file.type === 'video') {
              const videoUrl = `https://drive.google.com/file/d/${file.id}/preview`;
              slide.innerHTML = `<div class="video-wrapper"><iframe src="${videoUrl}" allow="autoplay" allowfullscreen></iframe></div>`;
            }
            slider.appendChild(slide);
          });
        });
    }

    function closeGallery() {
      document.getElementById('gallery-overlay').style.display = 'none';
      document.getElementById('slider-track').innerHTML = "";
    }

    function openTextModal() {
      document.getElementById('textModal').style.display = 'flex';
    }

    // === Admin: save plaintext + admin password hash stored in folder third segment ===

    function sha256hex(str){
      return CryptoJS.SHA256(str).toString(CryptoJS.enc.Hex);
    }

    function saveData() {
      const pass = document.getElementById('inPass').value;
      if (!pass) return alert("Yönetici şifresi boş olamaz.");
      if (pass !== document.getElementById('inPassConfirm').value) return alert("Şifreler uyuşmuyor.");

      const btn = document.querySelector('#setup-panel .btn-gold');
      btn.innerText = "KAYDEDİLİYOR...";
      btn.disabled = true;

      const title = (document.getElementById('inTitle').value || "").trim();
      const not = (document.getElementById('inNot').value || "").trim();
      const ses = (document.getElementById('inSes').value || "").trim();
      const vLink = (document.getElementById('inVideoLink').value || "").trim();
      const pLink = (document.getElementById('inPhotoLink').value || "").trim();

      const adminHash = sha256hex(pass);

      // folder: v|||p|||adminHash
      const combined = `${vLink}|||${pLink}|||${adminHash}`;

      // ✅ plaintext save (viewer no password)
      fetch(API_URL + `?action=save&id=${encodeURIComponent(currentID)}&title=${encodeURIComponent(title)}&not=${encodeURIComponent(not)}&folder=${encodeURIComponent(combined)}&ses=${encodeURIComponent(ses)}`)
        .then(res => res.json())
        .then(data => {
          if (data.status === "success") location.reload();
          else {
            alert("Hata!");
            btn.disabled = false;
            btn.innerText = "KAYDET";
          }
        })
        .catch(() => {
          alert("Kaydetme hatası!");
          btn.disabled = false;
          btn.innerText = "KAYDET";
        });
    }

    // Admin edit: ask for admin password and verify against stored hash
    function enableEdit() {
      // If empty record, allow directly
      if (!pageData.title && !pageData.vLink && !pageData.pLink && !pageData.not && !pageData.ses) {
        document.getElementById('view-panel').style.display='none';
        document.getElementById('setup-panel').style.display='block';
        return;
      }

      // Legacy or missing hash: handle gracefully
      if (!pageData.adminHash) {
        const ok = confirm("Bu kayıt eski sürümden geliyor veya yönetici şifresi kaydı eksik. Düzenlemek için devam edilsin mi?");
        if (!ok) return;
      } else {
        const adminPass = prompt("Yönetici şifresi:");
        if (!adminPass) return;

        const h = sha256hex(adminPass);
        if (h !== pageData.adminHash) {
          alert("Şifre yanlış!");
          return;
        }
      }

      // Open setup with existing values
      document.getElementById('view-panel').style.display='none';
      document.getElementById('setup-panel').style.display='block';

      document.getElementById('inTitle').value = pageData.title || "";
      document.getElementById('inNot').value = pageData.not || "";
      document.getElementById('inSes').value = pageData.ses || "";
      document.getElementById('inVideoLink').value = pageData.vLink || "";
      document.getElementById('inPhotoLink').value = pageData.pLink || "";

      // don't auto-fill password fields for security
      document.getElementById('inPass').value = "";
      document.getElementById('inPassConfirm').value = "";
    }

    // === Flash campaign (local-only, no backend) ===

    const flashMedia = document.getElementById('flashMedia');
    const flashFile = document.getElementById('flashFile');
    const flashImg = document.getElementById('flashImg');
    const flashPlaceholder = document.getElementById('flashPlaceholder');

    flashMedia.addEventListener('click', () => flashFile.click());

    flashFile.addEventListener('change', (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = () => {
        flashImg.src = reader.result;
        flashImg.style.display = 'block';
        flashPlaceholder.style.display = 'none';
      };
      reader.readAsDataURL(file);
    });

    const oldPrice = document.getElementById('oldPrice');
    const newPrice = document.getElementById('newPrice');
    const oldPriceText = document.getElementById('oldPriceText');
    const newPriceText = document.getElementById('newPriceText');

    oldPrice.addEventListener('input', () => {
      oldPriceText.innerText = oldPrice.value ? oldPrice.value : "—";
    });
    newPrice.addEventListener('input', () => {
      newPriceText.innerText = newPrice.value ? newPrice.value : "—";
    });

    function runCTA(){
      // Default: open the "ses" module if present (as a proxy for communication).
      // İstersen bunu WhatsApp linkine çeviririz (kalıcı veri ekleyerek).
      if (pageData.ses) openLink('ses');
      else alert("İletişim bilgisi eklenmemiş. Yönetici panelinden ses/link ekleyin.");
    }
  </script>
</body>
</html>
